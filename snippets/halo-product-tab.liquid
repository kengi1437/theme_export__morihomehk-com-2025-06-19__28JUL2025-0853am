{{ 'custom-tab-pages.css' | asset_url | stylesheet_tag }}
<script src="{{ 'custom-tab-accordion.js' | asset_url }}" defer></script>

{%- liquid
	assign tab_border_color = section.settings.tab_border_color
	assign tab_border_color_rgb = section.settings.tab_border_color_rgb
	if tab_border_color_rgb != blank
		assign border_color = tab_border_color_rgb
	else
		assign border_color = tab_border_color
	endif

	assign isVerticalSidebar = false
	if tab_layout == 'vertical_sidebar'
		assign isVerticalSidebar = 'sidebar'
	endif

	assign isVerticalSidebarMobile = false
	if tab_layout_mobile == 'vertical_sidebar'
		assign isVerticalSidebarMobile = 'sidebar-mobile'
	endif
-%}
<product-tab class="productView-tab layout-{{ tab_layout }} halo-product-tab" data-vertical="{{ isVerticalSidebar }}" data-vertical-mobile="{{ isVerticalSidebarMobile }}">
	{%- if tab_layout == 'horizontal' or tab_layout == 'popup' -%}
		<ul class="tabs tabs-horizontal list-unstyled disable-srollbar">
			{%- for block in section.blocks -%}
				{%- liquid
					assign title = block.settings.title
					assign key = block.settings.product_tab_key_metafield
                    assign source = block.settings.product_custom_source
					assign has_tab = false
    
                    if source == 'dynamic'
                       assign meta_ref = key
                    else
                    	if product.metafields.c_f or product.metafields.custom
                    		if product.metafields.c_f[key] != blank
	                			assign meta_ref = product.metafields.c_f[key]
	                		else
	                			assign meta_ref = product.metafields.custom[key]
                    		endif
	                	endif
                    endif 
                   
					if block.type == 'custom'
						if block.settings.type == 'metafield'
							if meta_ref
				                assign has_tab = true
				            else
				            	assign has_tab = false
				            endif
				        elsif block.settings.type == 'custom_tab_metafield'
				        	if product.metafields.custom.tab != blank
				        		assign metafield_value = product.metafields.custom.tab | strip
				        		if metafield_value contains 'gid://shopify/OnlineStorePage/'
				        			assign has_tab = true
				        		else
				        			assign has_tab = false
				        		endif
				        	else
				        		assign has_tab = false
				        	endif
				        else
				        	assign has_tab = true
				        endif
					else
						assign has_tab = true
					endif
				-%}
				{%- if has_tab and title != blank -%}
					<li class="tab">
			            <a class="tab-title{% if block.type == 'description' and tab_layout == 'horizontal' %} is-open{% endif %}" href="#tab-{{ block.settings.title | escape | handleize }}" style="--border-color: {{ border_color }}">
			                {{ block.settings.title | escape }}
			            </a>
			        </li>
			    {%- endif -%}
			{%- endfor -%}
		</ul>
	{%- endif -%}
	<div class="tabs-contents tabs-contents-{{ tab_layout }} clearfix halo-text-format">
		{%- for block in section.blocks -%}
			{%- liquid
				assign title = block.settings.title
				assign has_tab = false
				assign source = block.settings.product_custom_source
				assign key = block.settings.product_tab_key_metafield

				if source == 'dynamic'
                   assign meta_ref = key
                else
                	if product.metafields.c_f or product.metafields.custom
                		if product.metafields.c_f[key] != blank
                			assign meta_ref = product.metafields.c_f[key]
                		else
                			assign meta_ref = product.metafields.custom[key]
                		endif
                	endif
                endif 
                
				if block.type == 'custom'
					if block.settings.type == 'metafield'
						if meta_ref
			                assign has_tab = true
			                assign content = meta_ref
			            else
			            	assign has_tab = false
			            endif
			        elsif block.settings.type == 'custom_tab_metafield'
			        	if product.metafields.custom.tab != blank
			        		assign metafield_value = product.metafields.custom.tab | strip
			        		if metafield_value contains 'gid://shopify/OnlineStorePage/'
			        			assign has_tab = true
			        			assign content = ''
			        			assign page_gids = metafield_value | remove: '[' | remove: ']' | remove: '"' | split: ','
			        			assign pages_found = 0

			        			for page_gid in page_gids
			        				assign clean_gid = page_gid | strip
			        				assign page_id = clean_gid | split: '/' | last

			        				comment
			        				Try to find the page by iterating through all pages
			        				Since we can't access pages by ID directly, we need to check all pages
			        				endcomment

			        				for page in pages
			        					assign page_id_str = page.id | append: ''
			        					if page_id_str == page_id
			        						assign pages_found = pages_found | plus: 1
			        						unless content == ''
			        							assign content = content | append: '<div class="page-separator"></div>'
			        						endunless
			        						assign page_id = 'page-' | append: forloop.index
			        						assign content = content | append: '<div class="custom-tab-page">'
			        						assign content = content | append: '<input type="checkbox" id="' | append: page_id | append: '" class="page-toggle" style="display: none;">'
			        						assign content = content | append: '<label for="' | append: page_id | append: '" class="page-title">' | append: page.title | append: '</label>'
			        						assign content = content | append: '<div class="page-content">' | append: page.content | append: '</div>'
			        						assign content = content | append: '</div>'
			        						break
			        					endif
			        				endfor
			        			endfor

			        			if pages_found == 0
			        				assign content = '<div style="background: #fff3cd; padding: 15px; border: 1px solid #ffc107; margin: 10px 0;">'
			        				assign content = content | append: '<h4>頁面內容載入中...</h4>'
			        				assign content = content | append: '<p>找到 ' | append: page_gids.size | append: ' 個頁面引用，但無法直接載入內容。</p>'
			        				assign content = content | append: '<p>這可能是因為頁面權限設置或 Liquid 限制。</p>'
			        				assign content = content | append: '<p><strong>頁面 ID:</strong></p><ul>'
			        				for page_gid in page_gids
			        					assign clean_gid = page_gid | strip
			        					assign page_id = clean_gid | split: '/' | last
			        					assign content = content | append: '<li>' | append: page_id | append: '</li>'
			        				endfor
			        				assign content = content | append: '</ul></div>'
			        			endif
			        		else
			        			assign has_tab = false
			        		endif
			        	else
			        		assign has_tab = false
			        	endif
			        else
			        	assign has_tab = true
			        	assign content = block.settings.content
			        endif
				else
					assign has_tab = true
					if block.type == 'description'
                        assign current_variant = product.selected_or_first_available_variant
                        if current_variant.metafields.c_f.variant_description != blank
                            assign content = current_variant.metafields.c_f.variant_description
                        else
                            assign content = product.description
                        endif
					endif
				endif

				if block.type == 'description' or block.type == 'custom'
					assign style_mobile = false
					if block.settings.open_tab_mobile
						assign style_mobile = 'show-mobile'
					endif
					if tab_layout_mobile == 'popup'
						assign style_mobile = 'popup-mobile'
					elsif tab_layout_mobile == 'vertical_sidebar'
						assign style_mobile = 'sidebar-mobile'
					endif
				endif
			-%}
			{%- if has_tab and title != blank -%}
				<div class="tab-content{% if block.type == 'description' %}{% if tab_layout == 'vertical' or tab_layout == 'horizontal' %} is-active{% endif %}{% endif %}" id="tab-{{ title | escape | handleize }}">
					<div class="toggle-title{% if settings.product_page_layout == 'full_width_2' or template.suffix == 'template-full-width-2' %} title-content-full{% endif %}">
		                <a class="toggleLink{% if style_mobile %} {{ style_mobile }}{% endif %}{% if block.type == 'description' and tab_layout == 'vertical' %} is-open{% endif %}" data-collapsible href="#tab-{{ title | escape | handleize }}-mobile">
		                    <span class="text">
		                        {{ title | escape }}
		                    </span>
		                    {% if icon_style_layout == 'style_1' %}
			                    <span class="icon-dropdown">
			                    	{% if settings.product_page_layout == 'full_width_2' or template.suffix == 'template-full-width-2' %}
			                    		{% render 'icon-down-2' %}
			                    	{% else %}
			                    		{% render 'icon-down' %}
			                    	{% endif %}
			                    </span>
		                    {% else %}
		                    	<span class="icon-plus">&nbsp;</span>
		                    {% endif %}
		                </a>
		            </div>
		            <div class="toggle-content{% if block.type == 'description' %}{% if tab_layout == 'vertical' or tab_layout == 'horizontal' %} is-active{% endif %}{% endif %}{% if style_mobile %} {{ style_mobile }}{% endif %}{% if block.settings.enable_btn_show_more %} toggle-content--height{% endif %}" id="tab-{{ title | escape | handleize }}-mobile"{% if block.settings.enable_btn_show_more %} style="--maximum-des-to-show: {{ block.settings.maximum_des_to_show | append: 'px'}}"{% endif %}{% if block.type == 'description' %} product-description-tab data-product-description-{{ product.id }}{% endif %}>
						{%- if tab_layout == 'vertical_sidebar' or style_mobile == 'sidebar-mobile' or style_mobile == 'popup-mobile' -%}
							<div class="tab-popup-header">
								<h5>
									<span class="text">{{ title | escape }}</span>
								</h5>
								<a class="pdViewTab-close pdViewTab-close-mobile" role="link" aria-disabled="true">x</a>
							</div>
							<div class="tab-popup-content">
						{%- endif -%}
							{{ content }}
							{%- if block.settings.enable_btn_show_more -%}
								{% assign letter = content | size %}
								<div class="tab-showMore is-show" data-letter="{{ letter }}" data-des-max="{{ block.settings.maximum_des_to_show }}">
									<a class="button button--secondary" href="#tab-{{ title | escape | handleize }}-mobile" data-show-more-text="{{ 'products.product.read_more' | t }}" data-show-less-text="{{ 'products.product.read_less' | t }}" data-show-more-toogle>
										{{ 'products.product.read_more' | t }}
									</a>
								</div>
							{%- endif -%}
						{%- if tab_layout == 'vertical_sidebar' or style_mobile == 'sidebar-mobile' or style_mobile == 'popup-mobile' -%}
							</div>
						{%- endif -%}
		            </div>
					{%- if tab_layout == 'popup' -%}
						<a class="pdViewTab-close" href="javascript:void(0)">x</a>
					{%- endif -%}
				</div>
			{%- endif -%}
		{%- endfor -%}
	</div>
</product-tab>
<script src="{{ 'tabs.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'halo-faqs.js' | asset_url }}" defer="defer"></script>
{% assign description_tab = section.blocks | where: 'type', 'description' %}
{%- if description_tab == blank and tab_layout == 'horizontal' -%}
<script defer="defer">
	document.querySelector('.tabs-horizontal .tab:nth-child(1) .tab-title').classList.add('is-open');
	document.querySelector('.tabs-contents-horizontal .tab-content:nth-child(1)').classList.add('is-active');
	document.querySelector('.tabs-contents-horizontal .tab-content:nth-child(1) .toggleLink').classList.add('is-open');
	document.querySelector('.tabs-contents-horizontal .tab-content:nth-child(1) .toggle-content').style.display = 'block';
</script>
{%- endif -%}
{%- if tab_layout_mobile == 'vertical' and tab_layout == 'vertical' -%}
<script defer="defer">
	if (window.innerWidth < 551) {
		document.querySelector('.tabs-contents-vertical .tab-content .toggleLink').classList.remove('is-open');
	}
</script>
{%- endif -%}
